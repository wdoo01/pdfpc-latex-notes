\ProvidesPackage{pdfpcnotes}

% Handling of kv parameters.
% We have the following options, that all take time in the HH:MM format
\RequirePackage{kvoptions}
\RequirePackage{etoolbox}
\SetupKeyvalOptions{
  family=PDFPC,
  prefix=PDFPC@
}
\DeclareStringOption{duration}
\DeclareStringOption{starttime}
\DeclareStringOption{endtime}
\DeclareStringOption{lastminutes}
\DeclareStringOption{fontsize}

\ProcessKeyvalOptions*

% Small macro to make inserting options easier.
\newcommand\PDFPC@option[2]{
  \ifx#2\@empty\else
    \immediate\write\pdfpcnotesfile{[#1]}%
    \immediate\write\pdfpcnotesfile{#2}%
  \fi
}

% create a new file handle
\newwrite\pdfpcnotesfile

% open file on \begin{document}
\AtBeginDocument{%
	\immediate\openout\pdfpcnotesfile\jobname.pdfpc\relax
 \PDFPC@option{duration}{\PDFPC@duration}
 \PDFPC@option{start_time}{\PDFPC@starttime}
 \PDFPC@option{end_time}{\PDFPC@endtime}
 \PDFPC@option{last_minutes}{\PDFPC@lastminutes}
 \PDFPC@option{font_size}{\PDFPC@fontsize}
  \immediate\write\pdfpcnotesfile{[notes]}
}
% define a # http://tex.stackexchange.com/a/37757/10327
\begingroup
	\catcode`\#=12
	\gdef\hashchar{#}%
\endgroup


\def\lastframenumber{0}
\let\olditem\item

% define command \pnote{} that works like note but
% additionally writes notes to file in pdfpc readable format

%\patchcmd{\beamer@framenotesend}{\immediate\write\pdfpcnotesfile{%
	%\beamer@atbeginnote%
      %\beamer@notes%
      %\ifx\beamer@noteitems\@empty\else
      %\begin{enumerate}\itemsep=0pt\parskip=0pt%
        %\beamer@noteitems%
      %\end{enumerate}%
      %\fi%
      %\beamer@atendnote%
      %}}{}
\mode
<presentation>

\newcommand<>{\beamer@inframepnote}[2][]{%
  \ifbeamer@inlecture%
    \only#3{%
      \def\beamer@temp{#1}%
      \ifx\beamer@temp\beamer@itemtext%
        \expandafter\gdef\expandafter\beamer@noteitems%
        \expandafter{\beamer@noteitems\item#2}%
        \expandafter\gdef\expandafter\beamer@pnoteitems%
	\expandafter{\beamer@pnoteitems ^^J - #2}%
      \else%
        \expandafter\gdef\expandafter\beamer@notes%
          \expandafter{\beamer@notes#2}%
      \fi%
    }%
  \fi%
  \endgroup%
  }%
  


\pretocmd\beamer@framenotesbegin{%
    \gdef\beamer@pnoteitems{}
}{}{}
\pretocmd\beamer@framenotesend{%
		\begingroup
			\let\#\hashchar
			\immediate\write\pdfpcnotesfile{\#\#\# \theframenumber}%
		\endgroup%
      %\begin{enumerate}\itemsep=0pt\parskip=0pt%
      %\end{enumerate}%
		%\message{some notes here \begingroup \def\item{ } \beamer@noteitems \endgroup }%
		\begingroup\obeylines%
		\def\\{^^J}%
		\def\par{^^J^^J}%
    %\newlinechar`\^^M%
    \immediate\write\pdfpcnotesfile{%
	%\beamer@atbeginnote%
      \beamer@notes%
      \ifx\beamer@noteitems\@empty\else%
      %\begin{enumerate}\itemsep=0pt\parskip=0pt%
      %\def\item{ - }%
	\beamer@pnoteitems%
      %\end{enumerate}%
      \fi%
      %\beamer@atendnote%
}%
      \endgroup%
}{}{}

\def\pnote{%
  \ifbeamer@inframe%
  \let\next=\beamer@inframepnote%
  \else%
    \let\next=\beamer@outsideframepnote%
  \fi%
  \begingroup\renewcommand{\item}{\pitem}%
  \next}


%\define@key{beamerpnotes}{enumerate}[true]{%
  %\def\beamer@pnoteenvstart{\begin{enumerate}\itemsep=0pt\parskip=0pt}%
  %\def\beamer@pnoteenvend{\end{enumerate}}}
%\define@key{beamerpnotes}{itemize}[true]{%
  %\def\beamer@pnoteenvstart{\begin{itemize}\itemsep=0pt\parskip=0pt}%
  %\def\beamer@pnoteenvend{\end{itemize}}}
\define@key{beamerpnotes}{enumerate}[true]{%
    \def\beamer@pnoteenvstart{}%
    \def\beamer@pitem{^^J 1. }%
\def\beamer@pnoteenvend{}}
\define@key{beamerpnotes}{itemize}[true]{%
    \def\beamer@pnoteenvstart{}%
    \def\beamer@pitem{^^J - }%
\def\beamer@pnoteenvend{}}
\newcommand\beamer@outsideframepnote[2][]{%
  \beamer@savemode%
  \ifbeamer@inlecture%
    \def\beamer@noteenvstart{}%
    \def\beamer@noteenvend{}%
    \def\beamer@pnoteenvstart{}%
    \def\beamer@pnoteenvend{}%
    \def\beamer@pitem{}%
    \setkeys{beamernotes}{#1}%
    \setkeys{beamerpnotes}{#1}%
    \ifbeamer@notes
    \begingroup
      \setbeamertemplate{itemize item}{\textbullet}
      \setbeamertemplate{itemize subitem}{--}
      \setbeamertemplate{enumerate item}{\insertenumlabel.}
      \setbeamertemplate{enumerate subitem}{\insertenumlabel.\insertsubenumlabel}
      \def\@oddhead{}
      \def\@oddfoot{}
      \let\@evenhead\@oddhead
      \let\@evenfoot\@oddfoot
      \def\beamer@backgroundtemplate{}%
      \setbeamercolor{item}{fg=black,bg=white}
      \color{black}%
      \nointerlineskip
      \hbox{\hskip-\Gm@lmargin\hskip1cm\vbox to\textheight{%
                                  %pretend to have ``standard'' margins
          \edef\beamer@origlmargin{\Gm@lmargin}%
          \edef\beamer@origrmargin{\Gm@rmargin}%
          \def\Gm@lmargin{1cm}%
          \def\Gm@rmargin{1cm}%
          \textwidth=\dimexpr\paperwidth-\Gm@lmargin-\Gm@rmargin\relax%
          \hsize=\textwidth%
          \@arrayparboxrestore%
          \vskip-\headheight%
          \def\insertnote{\vbox{}%
            \beamer@noteenvstart%
	      \begingroup\let\pitem=\olditem
	    #2%
	    \endgroup%
	    \beamer@noteenvend%
          }%
		\begingroup
			\let\#\hashchar
			\immediate\write\pdfpcnotesfile{\#\#\# \theframenumber}%
		\endgroup%
		\begingroup
		\let\pitem=-
		\message{def def #2}
		\endgroup
		\begingroup
		\let\pitem=\beamer@pitem%
		\def\tmpvar{ \beamer@pnoteenvstart #2 \beamer@pnoteenvend }
	  \immediate\write\pdfpcnotesfile{ \tmpvar }%
		\endgroup

          \usebeamertemplate*{note page}%
          \vfil%
          \vskip-4pt% foot separator
          \vskip-\footheight}\hskip-\Gm@lmargin\hskip1cm}%
      \ifbeamer@twoscreensnotes%
        \pgfpagescurrentpagewillbelogicalpage{2}%
        \advance\c@page by-1\relax%
      \fi%
      \clearpage
      \endgroup
    \fi%
  \fi%
  \beamer@resumemode
  \endgroup
  %\let\item=\olditem%
  }


%\newcommand{\pnote}[1]{%
	%% keep normal notes working
	%\note{#1}%

	%% if frame changed - write a new header
	%\ifdim\theframenumber pt>\lastframenumber pt
		%\let\lastframenumber\theframenumber
		%\begingroup
			%\let\#\hashchar
			%\immediate\write\pdfpcnotesfile{\#\#\# \theframenumber}%
		%\endgroup
	%\fi

	%% write note to file
	%\immediate\write\pdfpcnotesfile{\unexpanded{#1}}%
%}
% close file on \end{document}
\AtEndDocument{%
	\immediate\closeout\pdfpcnotesfile
}

\mode
<article>
{
    \newcommand<>\pnote[2][]{}
}
\mode
<all>

